# Stripe 決済フロー テストガイド

このドキュメントでは、Stripe決済機能の動作確認手順を説明します。

## 前提条件

以下が完了していることを確認してください：

- [x] Stripeダッシュボードでテスト用Product/Priceを作成済み
- [x] `apps/web/.env.local` に環境変数を設定済み
- [x] Stripe CLIで `stripe listen` を実行中
- [x] 開発サーバー（`pnpm dev`）が起動中

## テストシナリオ

### 1. 基本フロー：サインアップからサブスクリプション購入まで

#### 1.1 ユーザー登録

1. ブラウザで `http://localhost:3000` にアクセス
2. 「サインアップ」をクリック
3. 以下の情報を入力：
   - 名前: `Test User`
   - メールアドレス: `test@example.com`
   - パスワード: `password123`
4. 「サインアップ」ボタンをクリック
5. **期待結果**: ダッシュボード（`/dashboard`）にリダイレクトされる

#### 1.2 料金プランページの確認

1. ヘッダーの「料金プラン」をクリック、または `/pricing` に直接アクセス
2. **期待結果**: 3つのプラン（月額、年額、都度課金）が表示される

#### 1.3 月額サブスクリプションの購入

1. 「月額プラン」の「サブスクリプションを開始」ボタンをクリック
2. **期待結果**: Stripe Checkoutページにリダイレクトされる
3. 以下のテストカード情報を入力：
   - **カード番号**: `4242 4242 4242 4242`
   - **有効期限**: `12/34`（任意の将来の日付）
   - **CVC**: `123`（任意の3桁）
   - **郵便番号**: `123-4567`（任意）
   - **カード名義**: `Test User`
4. 「申し込む」ボタンをクリック
5. **期待結果**: `/dashboard?success=true` にリダイレクトされる

#### 1.4 ダッシュボードでの確認

1. ダッシュボードの「サブスクリプション」セクションを確認
2. **期待結果**:
   - 月額プランが表示される
   - ステータスが「active」
   - 現在の期間（開始日〜終了日）が表示される
   - 「サブスクリプション管理」ボタンが表示される

#### 1.5 Webhookの確認

Stripe CLIのターミナル出力を確認：

```
✔ Received event: customer.subscription.created
✔ Received event: checkout.session.completed
✔ Received event: invoice.payment_succeeded
```

**期待結果**: 上記のイベントが受信され、エラーがないこと

#### 1.6 データベースの確認（オプション）

Drizzle Studioで確認：

```bash
pnpm db:studio
```

1. `subscriptions` テーブルを確認
   - 新しいレコードが作成されている
   - `status` が `active`
   - `userId` が正しいユーザーIDと一致
2. `products` と `prices` テーブルを確認
   - Stripeから同期されたデータが存在する

---

### 2. 都度課金の購入

1. `/pricing` にアクセス
2. 「都度課金」プランの「今すぐ購入」ボタンをクリック
3. Stripe Checkoutで同じテストカード情報を入力
4. 「支払う」ボタンをクリック
5. **期待結果**: `/dashboard?success=true` にリダイレクトされる
6. ダッシュボードの「支払い履歴」セクションを確認
7. **期待結果**:
   - ¥5,000の支払いが表示される
   - ステータスが「succeeded」
   - 日付が正しい

---

### 3. サブスクリプション管理（Billing Portal）

#### 3.1 ポータルへのアクセス

1. ダッシュボードの「サブスクリプション管理」ボタンをクリック
2. **期待結果**: Stripe Billing Portalにリダイレクトされる

#### 3.2 サブスクリプションの解約

1. Billing Portalで「キャンセル」をクリック
2. 解約理由を選択（任意）
3. 「サブスクリプションをキャンセル」を確認
4. **期待結果**: 解約が完了し、「期間終了時にキャンセルされます」と表示される
5. 「ダッシュボードに戻る」をクリック
6. ダッシュボードのサブスクリプションセクションを確認
7. **期待結果**: 「期間終了時にキャンセルされます」というメッセージが表示される

#### 3.3 Webhookの確認

Stripe CLIのターミナル出力を確認：

```
✔ Received event: customer.subscription.updated
```

**期待結果**: `customer.subscription.updated` イベントが受信される

---

### 4. キャンセルフロー

1. `/pricing` にアクセス
2. 任意のプランの購入ボタンをクリック
3. Stripe Checkoutページで「×」（閉じる）ボタンをクリック
4. **期待結果**: `/pricing?canceled=true` にリダイレクトされる
5. データベースを確認
6. **期待結果**: 新しいサブスクリプションや支払いは作成されていない

---

### 5. 未ログイン時の動作

1. ブラウザのシークレットモード（またはログアウト）で `http://localhost:3000/pricing` にアクセス
2. 任意のプランの購入ボタンをクリック
3. **期待結果**: `/sign-in?callbackUrl=/pricing` にリダイレクトされる
4. サインイン後、`/pricing` に戻る

---

### 6. 3Dセキュア認証（オプション）

3Dセキュアが必要なカードでのテスト：

1. `/pricing` で任意のプランを選択
2. Stripe Checkoutで以下のカード情報を入力：
   - **カード番号**: `4000 0027 6000 3184`
   - その他は通常のテストカードと同じ
3. **期待結果**: 3Dセキュア認証画面が表示される
4. 「Complete authentication」ボタンをクリック
5. **期待結果**: 認証が完了し、決済が成功する

---

### 7. 支払い失敗のテスト（オプション）

1. `/pricing` で任意のプランを選択
2. Stripe Checkoutで以下のカード情報を入力：
   - **カード番号**: `4000 0000 0000 9995`（支払い失敗カード）
   - その他は通常のテストカードと同じ
3. **期待結果**: 「カードが拒否されました」というエラーメッセージが表示される
4. データベースを確認
5. **期待結果**: 新しいサブスクリプションや支払いは作成されていない

---

## トラブルシューティング

### Webhookが受信されない

**症状**: Stripe CLIで「Received event」が表示されない

**解決方法**:

1. Stripe CLIの `stripe listen` コマンドが実行中か確認
2. ポート番号が正しいか確認（デフォルト: 3000）
3. `STRIPE_WEBHOOK_SECRET` が正しく設定されているか確認
4. 開発サーバーが起動しているか確認

### Checkoutページにリダイレクトされない

**症状**: 購入ボタンをクリックしてもCheckoutページに遷移しない

**解決方法**:

1. ブラウザのコンソールでエラーを確認
2. `STRIPE_SECRET_KEY` が正しく設定されているか確認
3. Price IDが正しく設定されているか確認
4. ユーザーがログインしているか確認

### データベースに反映されない

**症状**: Webhookは受信されるが、データベースに反映されない

**解決方法**:

1. サーバーログ（ターミナル）でエラーを確認
2. `TURSO_DATABASE_URL` と `TURSO_AUTH_TOKEN` が正しいか確認
3. マイグレーションが実行されているか確認（`pnpm db:push`）
4. Webhook処理のログを確認（`apps/web/app/api/stripe/webhook/route.ts`）

### ポータルにアクセスできない

**症状**: 「サブスクリプション管理」ボタンをクリックしてもエラーになる

**解決方法**:

1. ユーザーに `stripeCustomerId` が設定されているか確認
2. 少なくとも1回は決済を完了しているか確認
3. Stripe Billing Portalが有効になっているか確認（Stripeダッシュボード > 設定 > Billing）

---

## テストカード一覧

| カード番号            | 用途           | 結果           |
| --------------------- | -------------- | -------------- |
| `4242 4242 4242 4242` | 通常の成功     | 支払い成功     |
| `4000 0027 6000 3184` | 3Dセキュア必須 | 認証後に成功   |
| `4000 0000 0000 9995` | 支払い失敗     | カード拒否     |
| `4000 0000 0000 0341` | 残高不足       | 残高不足エラー |
| `4000 0000 0000 9987` | 紛失カード     | カード拒否     |

詳細は [Stripe テストカード一覧](https://stripe.com/docs/testing) を参照してください。

---

## チェックリスト

決済フローが正常に動作していることを確認するためのチェックリスト：

- [ ] サインアップ/サインインが正常に動作する
- [ ] 料金プランページが表示される
- [ ] 月額サブスクリプションの購入が完了する
- [ ] 年額サブスクリプションの購入が完了する
- [ ] 都度課金の購入が完了する
- [ ] ダッシュボードにサブスクリプション情報が表示される
- [ ] ダッシュボードに支払い履歴が表示される
- [ ] Billing Portalにアクセスできる
- [ ] サブスクリプションの解約ができる
- [ ] Webhookイベントが正常に受信される
- [ ] データベースにデータが正しく同期される
- [ ] 未ログイン時にサインインページにリダイレクトされる
- [ ] Checkoutキャンセル時に正しく処理される
- [ ] 3Dセキュア認証が動作する（オプション）
- [ ] 支払い失敗時に適切なエラーが表示される（オプション）

---

## 次のステップ

テストが完了したら：

1. 本番環境用のStripe Productを作成
2. 本番環境の環境変数を設定
3. Webhookエンドポイントを本番URLで設定
4. 実際の決済テストを行う（少額で）
5. エラーハンドリングとログを強化
6. メール通知の実装（購入完了、解約など）
7. 請求書のダウンロード機能の追加
